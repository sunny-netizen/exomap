<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!--
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
-->
    <meta name="viewport" content="width=device-width, initial-scale=3.0">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <script charset="utf-8" src="https://d3js.org/d3.v4.min.js"></script>
    <link href='exostyles.css' rel='stylesheet' />
    <title>ExoMap</title>
</head>

<body>
    <link href='exostyles.css' rel='stylesheet' />
    <div id="map"></div>
    <div class='map-overlay top'>
        <div class='map-overlay-inner'>
            <h2>Map of Confirmed Exoplanets</h2>
            <label id="year"></label>
            <table>
                <tr>
                    <td>
                        <input id='slider' type='range' min='0' max='33' step='1' value='0' list='tickmarks' />
                        <datalist id="tickmarks">
                            <option value="0" label="1989">
                            <option value="1">
                            <option value="2">
                            <option value="3">
                            <option value="4">
                            <option value="5">
                            <option value="6" label="1995">
                            <option value="7">
                            <option value="8">
                            <option value="9">
                            <option value="10">
                            <option value="11" label="2000">
                            <option value="12">
                            <option value="13">
                            <option value="14">
                            <option value="15">
                            <option value="16" label="2005">
                            <option value="17">
                            <option value="18">
                            <option value="19">
                            <option value="20">
                            <option value="21" label="2010">
                            <option value="22">
                            <option value="23">
                            <option value="24">
                            <option value="25">
                            <option value="26" label="2015">
                            <option value="27">
                            <option value="28">
                            <option value="29">
                            <option value="30">
                            <option value="31" label="2020">
                            <option value="32">
                            <option value="33" label="2022">
                        </datalist>
                    </td>
                    <td>
                        <label id='year'>2022</label>
                    </td>
                </tr>
            </table>
            <p class="credit">Data:
                <a href="https://exoplanetarchive.ipac.caltech.edu/">NASA Exoplanet Archive API</a>.
                Data Retrieved: March 3, 2022
            </p>
        </div>
        <div class="map-overlay-inner">
            <div id="legend" class="legend">
                <div class="bar"></div>
                <div>Magnitude (m)</div>
            </div>
        </div>
    </div>
    <!--<div class='map-overlay' id='legend'></div>-->
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoieXVuemhhbzIxIiwiYSI6ImNreWxnbDR2ejF5MjIyd3AwNXA1cDl1eGsifQ.64sJi7Q8xOekHT7A6IljEQ';
        var map = new mapboxgl.Map({ // Load a new map in the 'map' HTML div
            container: 'map', // container id
            style: 'mapbox://styles/yunzhao21/cl0iom6ww005b14qkazxo4lyz', // Using the standard Mapbox Dark style
            center: [0, 0], // starting position [lng, lat]
            zoom: 2 // starting zoom
        });
        const years = [
            '1989', '1990',
            '1991', '1992', '1993', '1994', '1995', '1996', '1997', '1998', '1999', '2000',
            '2001', '2002', '2003', '2004', '2005', '2006', '2007', '2008', '2009', '2010',
            '2011', '2012', '2013', '2014', '2015', '2016', '2017', '2018', '2019', '2020',
            '2021', '2022'
        ];

        map.on('load', function (data) { // Load map
            d3.json('ofrohn-d3-celestial/mw.json', function (mw) {
                /* map.addSource('milkyway', { //Add the geojson to the map.
                    'type': 'geojson',
                    'data': mw
                });
                map.addLayer({
                    id: 'milkyway-layer',
                    type: 'fill',
                    source: 'milkyway',
                    paint: {
                        'fill-color': '#0d0d0d'
                    }
                }); */
            })
            d3.json('ofrohn-d3-celestial/constellations.lines.json', function (l) {
                map.addSource('constellations_lines', { //Add the geojson to the map.
                    'type': 'geojson',
                    'data': l
                });
                map.addLayer({
                    id: 'constellations_lines-layer',
                    type: 'line',
                    source: 'constellations_lines',
                    paint: {
                        'line-color': '#3d3d3d',
                        'line-width': 3,
                        'line-blur': 1
                    }
                });
            })
            d3.json('ofrohn-d3-celestial/constellations.lines.cn.json', function (lcn) {

            })
            d3.json('ofrohn-d3-celestial/constellations.json', function (n) {
                console.log(n)
                map.addSource('constellations', { //Add the geojson to the map.
                    'type': 'geojson',
                    'data': n
                });
                map.addLayer({
                    id: 'constellations-layer',
                    type: 'symbol',
                    source: 'constellations',
                    layout: {
                        'text-anchor': 'center',
                        'text-field': '{name}',
                        'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                        'text-size': 12
                    },
                    paint: {
                        'text-color': '#808080'
                    }
                });
            })
            d3.json('ofrohn-d3-celestial/constellations.cn.json', function (ncn) {

            })
            d3.csv("ExoData.csv", function (ExoData) {  // Load JSON data and work on data
                //console.log(ExoData[0]);
                var exoGeojson = {}; // Create new GeoJSON  
                exoGeojson.type = 'FeatureCollection'; //Specify type is feature collection
                exoGeojson.features = []; //Create features array

                var i;
                for (i = 0; i < ExoData.length; i++) { //Loop through all exoplanets
                    var newFeature = { //Create each exoplanet feature as JSON object
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [ExoData[i].long, ExoData[i].lat]
                        },//geometry
                        "properties": {
                            "pl_name": ExoData[i]['pl_name'],
                            "hostname": ExoData[i]['hostname'],
                            "disc_year": ExoData[i]['disc_year'], //slider
                            "discoverymethod": ExoData[i]['discoverymethod'], //circle-color
                            "disc_facility": ExoData[i]['disc_facility'],
                            "sy_snum": ExoData[i]['sy_snum'],
                            "sy_pnum": ExoData[i]['sy_pnum'], //cluster-count, symbol layer
                            "sy_mnum": ExoData[i]['sy_mnum'],
                            "pl_orbper": ExoData[i]['pl_orbper'],
                            "pl_rade": ExoData[i]['pl_rade'], //circle-radius
                            "pl_radj": ExoData[i]['pl_radj'],
                            "pl_masse": ExoData[i]['pl_masse'],
                            "pl_massj": ExoData[i]['pl_massj'],
                            "pl_dens": ExoData[i]['pl_dens'],
                            "st_spectype": ExoData[i]['st_spectype'],
                            "sy_dist": ExoData[i]['sy_dist'], //3.5D
                            "ra": ExoData[i]['ra'],
                            "dec": ExoData[i]['dec']
                        }//properties
                    } //newFeature
                    //console.log(newFeature);
                    exoGeojson.features.push(newFeature); //Add the new feature to the features array 
                } //for loop
                //console.log(ExoData.long);
                //console.log(exoGeojson);


                //Sources
                map.addSource('ExoplanetGeojson', { //Add the geojson to the map.
                    'type': 'geojson',
                    'data': exoGeojson,
                });
                map.addSource('clustered_planets', { //Add the geojson to the map.
                    'type': 'geojson',
                    'data': exoGeojson,
                    'cluster': true,
                    'clusterRadius': 1, // Radius of each cluster when clustering points (defaults to 50)
                });

                //Layers
                map.addLayer({
                    id: 'Planets',
                    source: 'ExoplanetGeojson',
                    type: 'circle',
                    paint: {
                        'circle-color': {
                            property: 'discoverymethod',
                            type: "categorical",
                            stops: [
                                ['Transit', '#3bb2d0'],
                                ['Radial Velocity', '#fbb03b'],
                                ['Microlensing', '#FFB6C1'],
                                ['Transit Timing Variations', '#A39194'],
                                ['Imaging', '#223b53'],
                                ['Eclipse Timing Variations', '#e55e5e'],
                                ['Orbital Brightness Modulation', '#e234eb'],
                                ['Pulsar Timing', '#999999'],
                                ['Pulsation Timing Variations', '#e8eb34'],
                                ['Astrometry', '#34eb40'],
                                ['Disk Kinematics', '#7434eb']
                            ]
                        },
                        'circle-opacity': 0.6,
                        'circle-radius': 5
                    } //paint
                }) //addLayer

                // Function for changing data year. Reference: https://docs.mapbox.com/mapbox-gl-js/example/timeline-animation/
                function setYear(year) {
                    document.getElementById('year').textContent = years[year];  // Set the label to the correct year
                    var filters = ['<', 'disc_year', String(years[year])];
                    map.setFilter('Planets', filters);

                    /*
                    map.addLayer({
                        id: 'cluster-count',
                        type: 'symbol',
                        source: 'clustered_planets',
                        filter: ['has', 'point_count'],
                        layout: {
                            'text-field': '{point_count_abbreviated}',
                            'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                            'text-size': 12
                        }
                    }); */

                }// setYear

                // Reference: https://docs.mapbox.com/mapbox-gl-js/example/timeline-animation/
                setYear(33)
                document.getElementById('slider').addEventListener('input', (e) => {
                    const year = parseInt(e.target.value);
                    setYear(year);
                }); // EventListener

            }) // d3.csv

            const layers = [
                'Transit',
                'Radial Velocity',
                'Microlensing',
                'Transit Timing Variations',
                'Imaging',
                'Eclipse Timing Variations',
                'Orbital Brightness Modulation',
                'Orbital Brightness Modulation',
                'Pulsar Timing',
                'Pulsation Timing Variations',
                'Astrometry',
                'Disk Kinematics', 
                ];
            const colors = [
                '#3bb2d0',
                '#fbb03b',
                '#FFB6C1',
                '#A39194',
                '#223b53',
                '#e55e5e',
                '#e234eb',
                '#999999',
                '#e8eb34',
                '#34eb40',
                '#7434eb'
                ];

            // create legend
            const legend = document.getElementById('legend');

            layers.forEach((layer, i) => {
            const color = colors[i];
            const item = document.createElement('div');
            const key = document.createElement('span');
            key.className = 'legend-key';
            key.style.backgroundColor = color;

            const value = document.createElement('span');
            value.innerHTML = `${layer}`;
            item.appendChild(key);
            item.appendChild(value);
            legend.appendChild(item);
            });

        }) // map.on

        var mypopup = new mapboxgl.Popup({ offset: [150, 50], closeButton: false });
        // Another event listener that adds the popup when the user puts their cursor over planets
        map.on('mouseover', 'Planets', function (e) {
            mypopup.setLngLat(e.features[0].geometry.coordinates).setHTML(
                "<h3>Planet Name: " + e.features[0].properties.pl_name +
                //"</h3><b>Host Star Name: </b>" + e.features[0].hostname +
                "</h3><b>Discovery Year: </b>" + e.features[0].properties.disc_year +
                "<br /><b>Discovery Method: </b>" + e.features[0].properties.discoverymethod +
                "<br /><b>Discovery Facility: </b>" + e.features[0].properties.disc_facility +
                "<br /><b>Number of Stars: </b>" + e.features[0].properties.cb_flag +
                "<br /><b>Number of Planets: </b>" + e.features[0].properties.cb_flag +
                "<br /><b>Number of Moons: </b>" + e.features[0].properties.cb_flag +
                "<br /><b>Circumbinary: </b>" + e.features[0].properties.cb_flag +
                "<br /><b>Orbital Period [days]: </b>" + e.features[0].properties.pl_orbper +
                "<br /><b>Planet Radius [Earth Radius]: </b>" + e.features[0].properties.pl_rade +
                "<br /><b>Planet Radius [Jupiter Radius]: </b>" + e.features[0].properties.pl_radj +
                "<br /><b>Planet Mass [Earth Mass]: </b>" + e.features[0].properties.pl_masse +
                "<br /><b>Planet Mass [Jupiter Mass]: </b>" + e.features[0].properties.pl_massj +
                "<br /><b>Planet Density [g/cm**3]: </b>" + e.features[0].properties.pl_dens +
                "<br /><b>Host Spectral Type: </b>" + e.features[0].properties.st_spectype +
                "<br /><b>Distance from Earth [parsecs]: </b>" + e.features[0].properties.sy_dist +
                "<br /><b>RA [decimal]: </b>" + e.features[0].properties.ra +
                "<br /><b>Dec [decimal]: </b>" + e.features[0].properties.dec
            ).addTo(map);
        });


        // Change the cursor to a pointer when the mouse is over the stations layer.
        map.on('mouseenter', 'Planets', function () {
            map.getCanvas().style.cursor = 'pointer';
        });

        // Change it back to a pointer when it leaves and remove the popup window.
        map.on('mouseleave', 'Planets', function () {
            map.getCanvas().style.cursor = '';
            mypopup.remove();
        });

    </script>

    <!--
<a-scene embedded>
    <a-entity id="globeID" class="collidable" scale="0.1 0.1 0.1" globe="
        globe-image-url:
        https://upload.wikimedia.org/wikipedia/commons/0/04/Solarsystemscope_texture_8k_ea
        rth_daymap.jpg;
        bump-image-url:
        https://upload.wikimedia.org/wikipedia/commons/f/fb/Solarsystemscope_texture_8k_ea
        rth_normal_map.tif">
    </a-entity>
    <a-entity camera position="0 0 25"
                look-controls
                id="user"
                wasd-controls="acceleration: 45; fly: true;">
    <a-cursor color="lavender" opacity="0.5" raycaster="objects:
    .collidable"></a-cursor>
    </a-entity>
    <a-sky color="#001"></a-sky>
</a-scene>
-->


</body>

</html>